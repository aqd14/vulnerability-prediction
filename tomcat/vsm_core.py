import glob
import numpy
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from tomcat.text_cleanup import *

docs=[];
tfidf_vectorizer=[];

def init():

    global docs, tfidf_vectorizer;

    df = pd.read_csv('tomcat.csv', sep='|')


    print(df.shape)
    df = df[df['bug_id'].notnull()]
    print(df.shape)

    for idx,row in df.iterrows():
        current_document = row['change'] + '\n' + row['title'] + '\n' + row['description'];
        terms = preprocess(current_document);
        current_document=' '.join(terms);
        docs.append(current_document);

    tfidf_vectorizer = TfidfVectorizer(min_df=1, norm="l2", stop_words='english',
                                                 strip_accents='unicode', analyzer='word', ngram_range=(1, 2))

def query(doc):

    global docs;

    docs= [doc] + docs;

    tfidf_matrix= tfidf_vectorizer.fit_transform(docs)
    sim = cosine_similarity(tfidf_matrix[0:1], tfidf_matrix)
    docs.pop(0);
    sim=numpy.delete(sim,0)
    return sim


if __name__ == "__main__":
    docs=["m holo ekta tuntuni","t amak valobash na","imtiaz shoytan"]
    init()
    print(query("t valobash"))
    print(query("t shoytan"))